SELECT /*REQ.CD_CENTROCUSTO,*/
 RETORNA_PROD_DERIV(1,MOV.CODPRO) AS PRODUTO, REQ.CD_CENTROCUSTO, GEST.ID_NATUREZAGASTO
FROM   ESREQUISICAOESTOQUE REQ, ESREQUISICAOESTOQUEITEM RITEM, ESMOVESTOQUE MOV, ESMOVESTOQUEVALORES MVAL, TBPRODUTOS PRO, TBGRUPOSESTCUSTO GEST, TBTRANSEMP TNS,
       CLFORMACONT FRM
WHERE  REQ.CODEMP = &PCODEMP AND
       REQ.CODFIL = &PCODFIL AND
       REQ.DT_REQUISICAOESTOQUE BETWEEN &PPERIODO1 AND &PPERIODO2 AND
       REQ.TP_STATUS = 'CONFIRMADO' AND
       REQ.CD_CENTROCUSTO IS NOT NULL AND
       RITEM.ID_REQUISICAOESTOQUE = REQ.ID_REQUISICAOESTOQUE AND
       MOV.ID_MOVESTOQUE = RITEM.ID_MOVESTOQUE_SAI AND
       MOV.BO_MOSTRARAZAO = 'S' AND
       MVAL.ID_MOVESTOQUE = MOV.ID_MOVESTOQUE AND
       PRO.CODEMP = RITEM.CODEMP AND
       PRO.CODPRO = RITEM.CODPRO AND
       GEST.CODEMP = PRO.CODEMP AND
       GEST.CODGRUPOEST = (SELECT G1.CODGRUPOEST
                           FROM   TBPRODUTOSGRUPOESTCUSTO G1
                           WHERE  G1.CODEMP = PRO.CODEMP AND
                                  G1.CODPRO = PRO.CODPRO AND
                                  G1.DT_VIGENCIA = (SELECT MAX(G2.DT_VIGENCIA)
                                                    FROM   TBPRODUTOSGRUPOESTCUSTO G2
                                                    WHERE  G2.CODEMP = PRO.CODEMP AND
                                                           G2.CODPRO = PRO.CODPRO AND
                                                           G2.DT_VIGENCIA <= REQ.DT_REQUISICAOESTOQUE)) AND
       GEST.ID_NATUREZAGASTO IS NOT NULL AND
       NOT EXISTS (SELECT *
        FROM   CCCENTROCUSTONATUREZAGASTOS CNAT
        WHERE  CNAT.CD_CENTROCUSTO = REQ.CD_CENTROCUSTO AND
               CNAT.ID_NATUREZAGASTO = GEST.ID_NATUREZAGASTO) AND
       TNS.CODEMP = REQ.CODEMP AND
       TNS.CODFIL = REQ.CODFIL AND
       TNS.CODTNS = REQ.CODTNS AND
       FRM.CODEMP = TNS.CODEMP AND
       FRM.CODFIL = TNS.CODFIL AND
       FRM.CODFRM = TNS.CODFRM
GROUP  BY RETORNA_PROD_DERIV(1,MOV.CODPRO), REQ.CD_CENTROCUSTO, GEST.ID_NATUREZAGASTO
HAVING SUM(MVAL.VL_TOTAL) > 0
UNION ALL
-- TRANSPORTES
SELECT /*FIL.CD_CENTROCUSTO_MANUT_TRANSP AS CD_CENTROCUSTO, */
 RETORNA_PROD_DERIV(1,MOV.CODPRO) AS PRODUTO, FIL.CD_CENTROCUSTO_MANUT_TRANSP AS CD_CENTROCUSTO, GEST.ID_NATUREZAGASTO
FROM   ETSAIDAS SAI, TBPRODUTOS PRO, TBGRUPOSESTCUSTO GEST, /*CCCENTROCUSTONATUREZAGASTOS CNAT, */ TBTRANSEMP TNS, CLFORMACONT FRM, ESMOVESTOQUE MOV, ESMOVESTOQUEVALORES MVAL, TBFILIAIS FIL
WHERE  SAI.CODEMP = &PCODEMP AND
       SAI.CODFIL = &PCODFIL AND
       SAI.DATAMOV BETWEEN &PPERIODO1 AND &PPERIODO2 AND
       SAI.ORDEMTP IS NOT NULL AND
       MOV.ID_MOVESTOQUE = SAI.IDMOVEST AND
       MOV.BO_MOSTRARAZAO = 'S' AND
       MVAL.ID_MOVESTOQUE = MOV.ID_MOVESTOQUE AND
       PRO.CODEMP = SAI.CODEMP AND
       PRO.CODPRO = SAI.CODPRO AND
       GEST.CODEMP = PRO.CODEMP AND
       GEST.CODGRUPOEST = (SELECT G1.CODGRUPOEST
                           FROM   TBPRODUTOSGRUPOESTCUSTO G1
                           WHERE  G1.CODEMP = PRO.CODEMP AND
                                  G1.CODPRO = PRO.CODPRO AND
                                  G1.DT_VIGENCIA = (SELECT MAX(G2.DT_VIGENCIA)
                                                    FROM   TBPRODUTOSGRUPOESTCUSTO G2
                                                    WHERE  G2.CODEMP = PRO.CODEMP AND
                                                           G2.CODPRO = PRO.CODPRO AND
                                                           G2.DT_VIGENCIA <= SAI.DATAMOV)) AND
       GEST.ID_NATUREZAGASTO IS NOT NULL AND
       FIL.CODEMP = SAI.CODEMP AND
       FIL.CODFIL = SAI.CODFIL AND
       NOT EXISTS (SELECT *
        FROM   CCCENTROCUSTONATUREZAGASTOS CNAT
        WHERE  CNAT.CD_CENTROCUSTO = FIL.CD_CENTROCUSTO_MANUT_TRANSP AND
               CNAT.ID_NATUREZAGASTO = GEST.ID_NATUREZAGASTO) AND
       TNS.CODEMP = SAI.CODEMP AND
       TNS.CODFIL = SAI.CODFIL AND
       TNS.CODTNS = SAI.CODTNS AND
       FRM.CODEMP = TNS.CODEMP AND
       FRM.CODFIL = TNS.CODFIL AND
       FRM.CODFRM = TNS.CODFRM
GROUP  BY RETORNA_PROD_DERIV(1,MOV.CODPRO), FIL.CD_CENTROCUSTO_MANUT_TRANSP, GEST.ID_NATUREZAGASTO
UNION ALL
-- MANUTENÇÃO INDUSTRIAL
SELECT /*FIL.CD_CENTROCUSTO_MANUT_INDUST AS CD_CENTROCUSTO, */
RETORNA_PROD_DERIV(1,MOV.CODPRO) AS PRODUTO, FIL.CD_CENTROCUSTO_MANUT_INDUST AS CD_CENTROCUSTO, GEST.ID_NATUREZAGASTO
FROM   ETSAIDAS SAI, TBPRODUTOS PRO, TBGRUPOSESTCUSTO GEST, /*CCCENTROCUSTONATUREZAGASTOS CNAT,*/ TBTRANSEMP TNS, CLFORMACONT FRM, ESMOVESTOQUE MOV, ESMOVESTOQUEVALORES MVAL, TBFILIAIS FIL
WHERE  SAI.CODEMP = &PCODEMP AND
       SAI.CODFIL = &PCODFIL AND
       SAI.DATAMOV BETWEEN &PPERIODO1 AND &PPERIODO2 AND
       SAI.ORDEMMI IS NOT NULL AND
       MOV.ID_MOVESTOQUE = SAI.IDMOVEST AND
       MOV.BO_MOSTRARAZAO = 'S' AND
       MVAL.ID_MOVESTOQUE = MOV.ID_MOVESTOQUE AND
       PRO.CODEMP = SAI.CODEMP AND
       PRO.CODPRO = SAI.CODPRO AND
       GEST.CODEMP = PRO.CODEMP AND
       GEST.CODGRUPOEST = (SELECT G1.CODGRUPOEST
                           FROM   TBPRODUTOSGRUPOESTCUSTO G1
                           WHERE  G1.CODEMP = PRO.CODEMP AND
                                  G1.CODPRO = PRO.CODPRO AND
                                  G1.DT_VIGENCIA = (SELECT MAX(G2.DT_VIGENCIA)
                                                    FROM   TBPRODUTOSGRUPOESTCUSTO G2
                                                    WHERE  G2.CODEMP = PRO.CODEMP AND
                                                           G2.CODPRO = PRO.CODPRO AND
                                                           G2.DT_VIGENCIA <= SAI.DATAMOV)) AND
       GEST.ID_NATUREZAGASTO IS NOT NULL AND
       FIL.CODEMP = SAI.CODEMP AND
       FIL.CODFIL = SAI.CODFIL AND
       NOT EXISTS (SELECT *
        FROM   CCCENTROCUSTONATUREZAGASTOS CNAT
        WHERE  CNAT.CD_CENTROCUSTO = FIL.CD_CENTROCUSTO_MANUT_INDUST AND
               CNAT.ID_NATUREZAGASTO = GEST.ID_NATUREZAGASTO) AND
       TNS.CODEMP = SAI.CODEMP AND
       TNS.CODFIL = SAI.CODFIL AND
       TNS.CODTNS = SAI.CODTNS AND
       FRM.CODEMP = TNS.CODEMP AND
       FRM.CODFIL = TNS.CODFIL AND
       FRM.CODFRM = TNS.CODFRM
GROUP BY RETORNA_PROD_DERIV(1,MOV.CODPRO), FIL.CD_CENTROCUSTO_MANUT_INDUST, GEST.ID_NATUREZAGASTO

